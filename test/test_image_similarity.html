<!DOCTYPE html>
<html>
<head>
    <title>Image Similarity Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-card {
            border: 1px solid #eee;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        .image-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .image-card canvas {
            max-width: 100%;
            border: 1px solid #ddd;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .product-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .similarity-bar {
            width: 100px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        .similarity-fill {
            height: 100%;
            background: linear-gradient(to right, #ff6b6b, #51cf66);
            transition: width 0.3s;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üîç Image Similarity Search Test</h1>
    
    <div class="test-section">
        <h2>Generate Test Images</h2>
        <button onclick="generateAllImages()">Generate Product Images</button>
        
        <div class="image-grid" id="imageGrid"></div>
    </div>
    
    <div class="test-section">
        <h2>Search Results</h2>
        <div id="selectedImage" style="margin: 10px 0;"></div>
        <div class="results" id="results">
            <p>Select an image above to search for similar products</p>
        </div>
    </div>

    <script>
        let testImages = {};
        
        function generateProductImage(type, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 200, 200);
            
            if (type === 'shirt') {
                // T-shirt shape
                ctx.fillStyle = color;
                // Body
                ctx.beginPath();
                ctx.moveTo(60, 60);
                ctx.lineTo(140, 60);
                ctx.lineTo(140, 150);
                ctx.lineTo(60, 150);
                ctx.closePath();
                ctx.fill();
                
                // Sleeves
                ctx.beginPath();
                ctx.moveTo(60, 60);
                ctx.lineTo(40, 80);
                ctx.lineTo(40, 100);
                ctx.lineTo(60, 80);
                ctx.closePath();
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(140, 60);
                ctx.lineTo(160, 80);
                ctx.lineTo(160, 100);
                ctx.lineTo(140, 80);
                ctx.closePath();
                ctx.fill();
                
                // Collar
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(100, 60, 20, Math.PI, 0, false);
                ctx.stroke();
                
            } else if (type === 'jacket') {
                ctx.fillStyle = color;
                // Main body
                ctx.fillRect(50, 50, 100, 120);
                
                // Collar
                ctx.beginPath();
                ctx.moveTo(50, 50);
                ctx.lineTo(70, 30);
                ctx.lineTo(130, 30);
                ctx.lineTo(150, 50);
                ctx.closePath();
                ctx.fill();
                
                // Zipper
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(100, 50);
                ctx.lineTo(100, 170);
                ctx.stroke();
                
                // Pockets
                ctx.fillRect(60, 120, 30, 20);
                ctx.fillRect(110, 120, 30, 20);
                
            } else if (type === 'shoe') {
                ctx.fillStyle = color;
                // Shoe shape
                ctx.beginPath();
                ctx.ellipse(100, 100, 80, 40, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Heel
                ctx.fillStyle = darkenColor(color);
                ctx.beginPath();
                ctx.ellipse(140, 100, 40, 30, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Laces
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                for (let i = 0; i < 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(60 + i * 15, 90);
                    ctx.lineTo(60 + i * 15, 110);
                    ctx.stroke();
                }
            }
            
            return canvas;
        }
        
        function darkenColor(color) {
            const colors = {
                'red': 'darkred',
                'blue': 'darkblue',
                'green': 'darkgreen',
                'gray': 'darkgray',
                'black': 'black'
            };
            return colors[color] || color;
        }
        
        function generateAllImages() {
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            
            const products = [
                { type: 'shirt', color: 'red', name: 'Red T-Shirt' },
                { type: 'shirt', color: 'blue', name: 'Blue T-Shirt' },
                { type: 'shirt', color: 'green', name: 'Green T-Shirt' },
                { type: 'jacket', color: 'blue', name: 'Blue Jacket' },
                { type: 'jacket', color: 'black', name: 'Black Jacket' },
                { type: 'shoe', color: 'gray', name: 'Gray Sneakers' },
                { type: 'shoe', color: 'black', name: 'Black Shoes' }
            ];
            
            products.forEach(product => {
                const canvas = generateProductImage(product.type, product.color);
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `<h4>${product.name}</h4>`;
                card.appendChild(canvas);
                
                // Store base64
                const base64 = canvas.toDataURL().split(',')[1];
                testImages[product.name] = base64;
                
                card.onclick = () => searchSimilar(product.name, base64);
                imageGrid.appendChild(card);
            });
        }
        
        async function searchSimilar(imageName, base64Image) {
            const selectedDiv = document.getElementById('selectedImage');
            const resultsDiv = document.getElementById('results');
            
            selectedDiv.innerHTML = `<strong>Searching for products similar to:</strong> ${imageName}`;
            resultsDiv.innerHTML = '<p>üîÑ Searching...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Find products similar to this ${imageName}`,
                        image: base64Image
                    })
                });
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <h3>Agent Response:</h3>
                    <p>${data.response}</p>
                `;
                
                if (data.products && data.products.length > 0) {
                    resultsDiv.innerHTML += '<h3>Similar Products:</h3>';
                    
                    data.products.forEach(product => {
                        const similarity = product.metadata?.similarity_score || product.similarity_score || 0;
                        const similarityPercent = Math.round(similarity * 100);
                        
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product-result';
                        productDiv.innerHTML = `
                            <div>
                                <strong>${product.name}</strong><br>
                                $${product.price} - ${product.description}
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div class="similarity-bar">
                                    <div class="similarity-fill" style="width: ${similarityPercent}%"></div>
                                </div>
                                <span>${similarityPercent}%</span>
                            </div>
                        `;
                        resultsDiv.appendChild(productDiv);
                    });
                } else {
                    resultsDiv.innerHTML += '<p>No similar products found.</p>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        }
        
        // Generate images on load
        window.onload = generateAllImages;
    </script>
</body>
</html>